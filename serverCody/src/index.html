<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление системой обогрева</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .card {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .device-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .device-card {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 15px;
            position: relative;
        }
        .device-card.offline {
            opacity: 0.7;
        }
        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .device-name {
            font-weight: bold;
            font-size: 18px;
        }
        .device-status {
            font-size: 14px;
            padding: 3px 8px;
            border-radius: 10px;
        }
        .status-online {
            background-color: #2ecc71;
            color: white;
        }
        .status-offline {
            background-color: #e74c3c;
            color: white;
        }
        .device-data {
            margin-bottom: 15px;
        }
        .data-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .data-label {
            color: #7f8c8d;
        }
        .data-value {
            font-weight: bold;
        }
        .device-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .temperature-control {
            display: flex;
            align-items: center;
        }
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn:hover {
            background-color: #2980b9;
        }
        .btn-danger {
            background-color: #e74c3c;
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }
        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }
        .temperature-display {
            margin: 0 10px;
            font-weight: bold;
            min-width: 40px;
            text-align: center;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2ecc71;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-control {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .gpio-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .gpio-chip {
            background-color: #ecf0f1;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
        }
        .gpio-chip.selected {
            background-color: #3498db;
            color: white;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border-radius: 5px;
            width: 80%;
            max-width: 500px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        .battery-indicator {
            width: 100%;
            height: 10px;
            background-color: #ecf0f1;
            border-radius: 5px;
            margin-top: 5px;
        }
        .battery-level {
            height: 100%;
            border-radius: 5px;
            background-color: #2ecc71;
        }
        .battery-low {
            background-color: #e74c3c;
        }
        .battery-medium {
            background-color: #f39c12;
        }
        .heating-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .heating-on {
            background-color: #e74c3c;
            animation: pulse 1.5s infinite;
        }
        .heating-off {
            background-color: #7f8c8d;
        }
        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Система управления обогревом</h1>
            <p id="wifi-status">Статус WiFi: Подключено</p>
        </div>
        
        <div class="card">
            <h2>Устройства</h2>
            <button id="add-device-btn" class="btn">Добавить устройство</button>
            <button id="scan-devices-btn" class="btn">Сканировать датчики</button>
            <div id="device-list" class="device-list">
                <!-- Устройства будут добавлены здесь динамически -->
            </div>
        </div>
        
        <div class="card">
            <h2>Статистика системы</h2>
            <div class="data-row">
                <span class="data-label">Всего устройств:</span>
                <span id="total-devices" class="data-value">0</span>
            </div>
            <div class="data-row">
                <span class="data-label">Активных устройств:</span>
                <span id="active-devices" class="data-value">0</span>
            </div>
            <div class="data-row">
                <span class="data-label">Устройств в сети:</span>
                <span id="online-devices" class="data-value">0</span>
            </div>
            <div class="data-row">
                <span class="data-label">Активных обогревателей:</span>
                <span id="active-heaters" class="data-value">0</span>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно для добавления устройства -->
    <div id="add-device-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Добавить устройство</h2>
            <form id="add-device-form">
                <div class="form-group">
                    <label for="device-name">Название устройства</label>
                    <input type="text" id="device-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="device-mac">MAC-адрес датчика</label>
                    <input type="text" id="device-mac" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="device-temperature">Целевая температура (°C)</label>
                    <input type="number" id="device-temperature" class="form-control" value="20" min="0" max="40" step="0.5" required>
                </div>
                <div class="form-group">
                    <label>GPIO пины</label>
                    <div id="gpio-selector" class="gpio-selector">
                        <!-- GPIO пины будут добавлены здесь динамически -->
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="device-enabled" checked>
                        Включено
                    </label>
                </div>
                <button type="submit" class="btn">Сохранить</button>
            </form>
        </div>
    </div>
    
    <!-- Модальное окно для выбора датчика -->
    <div id="select-sensor-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Выберите датчик</h2>
            <div id="sensor-list">
                <!-- Датчики будут добавлены здесь динамически -->
            </div>
        </div>
    </div>
    
    <script>
        // Доступные GPIO пины
        const availableGpio = [25, 26, 27, 32, 33];
        
        // Загрузка данных при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            loadDevices();
            updateWifiStatus();
            
            // Инициализация GPIO селектора
            const gpioSelector = document.getElementById('gpio-selector');
            availableGpio.forEach(gpio => {
                const chip = document.createElement('div');
                chip.className = 'gpio-chip';
                chip.textContent = 'GPIO ' + gpio;
                chip.dataset.gpio = gpio;
                chip.addEventListener('click', function() {
                    this.classList.toggle('selected');
                });
                gpioSelector.appendChild(chip);
            });
            
            // Обработчики событий для кнопок
            document.getElementById('add-device-btn').addEventListener('click', showAddDeviceModal);
            document.getElementById('scan-devices-btn').addEventListener('click', scanDevices);
            document.getElementById('add-device-form').addEventListener('submit', addDevice);
            
            // Закрытие модальных окон
            document.querySelectorAll('.close').forEach(closeBtn => {
                closeBtn.addEventListener('click', function() {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                });
            });
            
            // Закрытие модальных окон при клике вне их содержимого
            window.addEventListener('click', function(event) {
                document.querySelectorAll('.modal').forEach(modal => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });
            
            // Обновление данных каждые 10 секунд
            setInterval(loadDevices, 10000);
        });
        
        // Загрузка списка устройств
        function loadDevices() {
            fetch('/api/devices')
                .then(response => response.json())
                .then(data => {
                    renderDevices(data.devices);
                    updateStatistics(data.devices);
                })
                .catch(error => console.error('Ошибка загрузки устройств:', error));
        }
        
        // Отображение устройств
        function renderDevices(devices) {
            const deviceList = document.getElementById('device-list');
            deviceList.innerHTML = '';
            
            if (devices.length === 0) {
                deviceList.innerHTML = '<p>Нет добавленных устройств</p>';
                return;
            }
            
            devices.forEach(device => {
                const deviceCard = document.createElement('div');
                deviceCard.className = `device-card ${device.isOnline ? '' : 'offline'}`;
                
                const needsHeating = device.enabled && device.isOnline && 
                                    (device.currentTemperature + 2) < device.targetTemperature;
                
                deviceCard.innerHTML = `
                    <div class="device-header">
                        <div class="device-name">${device.name}</div>
                        <div class="device-status ${device.isOnline ? 'status-online' : 'status-offline'}">
                            ${device.isOnline ? 'Онлайн' : 'Оффлайн'}
                        </div>
                    </div>
                    <div class="device-data">
                        <div class="data-row">
                            <span class="data-label">Текущая температура:</span>
                            <span class="data-value">${device.isOnline ? device.currentTemperature + '°C' : 'Н/Д'}</span>
                        </div>
                       <div class="data-row">
                            <span class="data-label">Целевая температура:</span>
                            <span class="data-value">${device.targetTemperature}°C</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Влажность:</span>
                            <span class="data-value">${device.isOnline ? device.humidity + '%' : 'Н/Д'}</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Батарея:</span>
                            <span class="data-value">${device.isOnline ? device.battery + '%' : 'Н/Д'}</span>
                        </div>
                        <div class="battery-indicator">
                            <div class="battery-level ${getBatteryClass(device.battery)}" 
                                 style="width: ${device.isOnline ? device.battery + '%' : '0%'}"></div>
                        </div>
                        <div class="data-row">
                            <span class="data-label">MAC-адрес:</span>
                            <span class="data-value">${device.macAddress}</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">GPIO пины:</span>
                            <span class="data-value">${device.gpioPins.join(', ')}</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Время работы:</span>
                            <span class="data-value">${formatTime(device.gpioOnTime)}</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Статус обогрева:</span>
                            <span class="data-value">
                                <span class="heating-indicator ${needsHeating ? 'heating-on' : 'heating-off'}"></span>
                                ${needsHeating ? 'Включен' : 'Выключен'}
                            </span>
                        </div>
                    </div>
                    <div class="device-controls">
                        <div class="temperature-control">
                            <button class="btn btn-small" onclick="decreaseTemperature('${device.macAddress}')">-</button>
                            <span class="temperature-display">${device.targetTemperature}°C</span>
                            <button class="btn btn-small" onclick="increaseTemperature('${device.macAddress}')">+</button>
                        </div>
                        <label class="switch">
                            <input type="checkbox" ${device.enabled ? 'checked' : ''} 
                                   onchange="toggleDevice('${device.macAddress}', this.checked)">
                            <span class="slider"></span>
                        </label>
                        <button class="btn btn-danger btn-small" onclick="deleteDevice('${device.macAddress}')">Удалить</button>
                    </div>
                `;
                
                deviceList.appendChild(deviceCard);
            });
        }
        
        // Обновление статистики
        function updateStatistics(devices) {
            const totalDevices = devices.length;
            const activeDevices = devices.filter(d => d.enabled).length;
            const onlineDevices = devices.filter(d => d.isOnline).length;
            const activeHeaters = devices.filter(d => 
                d.enabled && d.isOnline && (d.currentTemperature + 2) < d.targetTemperature
            ).length;
            
            document.getElementById('total-devices').textContent = totalDevices;
            document.getElementById('active-devices').textContent = activeDevices;
            document.getElementById('online-devices').textContent = onlineDevices;
            document.getElementById('active-heaters').textContent = activeHeaters;
        }
        
        // Обновление статуса WiFi
        function updateWifiStatus() {
            fetch('/api/wifi/status')
                .then(response => response.json())
                .then(data => {
                    const wifiStatus = document.getElementById('wifi-status');
                    if (data.connected) {
                        wifiStatus.textContent = `Статус WiFi: Подключено (IP: ${data.ip})`;
                        wifiStatus.style.color = '#2ecc71';
                    } else {
                        wifiStatus.textContent = 'Статус WiFi: Отключено';
                        wifiStatus.style.color = '#e74c3c';
                    }
                })
                .catch(error => console.error('Ошибка получения статуса WiFi:', error));
        }
        
        // Показать модальное окно добавления устройства
        function showAddDeviceModal() {
            document.getElementById('add-device-modal').style.display = 'block';
            document.getElementById('device-name').value = '';
            document.getElementById('device-mac').value = '';
            document.getElementById('device-temperature').value = '20';
            document.getElementById('device-enabled').checked = true;
            
            // Сбросить выбор GPIO
            document.querySelectorAll('.gpio-chip').forEach(chip => {
                chip.classList.remove('selected');
            });
        }
        
        // Сканирование доступных датчиков
        function scanDevices() {
            const scanBtn = document.getElementById('scan-devices-btn');
            scanBtn.textContent = 'Сканирование...';
            scanBtn.disabled = true;
            
            fetch('/api/sensors/scan', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        setTimeout(() => {
                            loadSensors();
                            document.getElementById('select-sensor-modal').style.display = 'block';
                        }, 5000); // Даем время на сканирование
                    } else {
                        alert('Ошибка при сканировании: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Ошибка сканирования:', error);
                    alert('Ошибка при сканировании датчиков');
                })
                .finally(() => {
                    scanBtn.textContent = 'Сканировать датчики';
                    scanBtn.disabled = false;
                });
        }
        
        // Загрузка доступных датчиков
        function loadSensors() {
            fetch('/api/sensors')
                .then(response => response.json())
                .then(data => {
                    const sensorList = document.getElementById('sensor-list');
                    sensorList.innerHTML = '';
                    
                    if (data.sensors.length === 0) {
                        sensorList.innerHTML = '<p>Датчики не найдены</p>';
                        return;
                    }
                    
                    data.sensors.forEach(sensor => {
                        const sensorItem = document.createElement('div');
                        sensorItem.className = 'device-card';
                        sensorItem.innerHTML = `
                            <div class="device-header">
                                <div class="device-name">${sensor.name}</div>
                                <div class="device-status status-online">Доступен</div>
                            </div>
                            <div class="device-data">
                                <div class="data-row">
                                    <span class="data-label">Температура:</span>
                                    <span class="data-value">${sensor.temperature}°C</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">Влажность:</span>
                                    <span class="data-value">${sensor.humidity}%</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">Батарея:</span>
                                    <span class="data-value">${sensor.battery}%</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">MAC-адрес:</span>
                                    <span class="data-value">${sensor.macAddress}</span>
                                </div>
                            </div>
                            <button class="btn" onclick="selectSensor('${sensor.name}', '${sensor.macAddress}')">Выбрать</button>
                        `;
                        sensorList.appendChild(sensorItem);
                    });
                })
                .catch(error => console.error('Ошибка загрузки датчиков:', error));
        }
        
        // Выбор датчика из списка
        function selectSensor(name, macAddress) {
            document.getElementById('device-name').value = name;
            document.getElementById('device-mac').value = macAddress;
            document.getElementById('select-sensor-modal').style.display = 'none';
            document.getElementById('add-device-modal').style.display = 'block';
        }
        
        // Добавление нового устройства
        function addDevice(event) {
            event.preventDefault();
            
            const name = document.getElementById('device-name').value;
            const macAddress = document.getElementById('device-mac').value;
            const targetTemperature = parseFloat(document.getElementById('device-temperature').value);
            const enabled = document.getElementById('device-enabled').checked;
            
            // Собираем выбранные GPIO пины
            const gpioPins = [];
            document.querySelectorAll('.gpio-chip.selected').forEach(chip => {
                gpioPins.push(parseInt(chip.dataset.gpio));
            });
            
            const deviceData = {
                name,
                macAddress,
                targetTemperature,
                enabled,
                gpioPins
            };
            
            fetch('/api/devices', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(deviceData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('add-device-modal').style.display = 'none';
                    loadDevices();
                } else {
                    alert('Ошибка при добавлении устройства: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Ошибка добавления устройства:', error);
                alert('Ошибка при добавлении устройства');
            });
        }
        
        // Удаление устройства
        function deleteDevice(macAddress) {
            if (confirm('Вы уверены, что хотите удалить это устройство?')) {
                fetch(`/api/devices?macAddress=${macAddress}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        loadDevices();
                    } else {
                        alert('Ошибка при удалении устройства: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Ошибка удаления устройства:', error);
                    alert('Ошибка при удалении устройства');
                });
            }
        }
        
        // Увеличение целевой температуры
        function increaseTemperature(macAddress) {
            updateDeviceTemperature(macAddress, 0.5);
        }
        
        // Уменьшение целевой температуры
        function decreaseTemperature(macAddress) {
            updateDeviceTemperature(macAddress, -0.5);
        }
        
        // Обновление температуры устройства
        function updateDeviceTemperature(macAddress, delta) {
            fetch('/api/devices')
                .then(response => response.json())
                .then(data => {
                    const device = data.devices.find(d => d.macAddress === macAddress);
                    if (device) {
                        const newTemperature = device.targetTemperature + delta;
                        if (newTemperature >= 0 && newTemperature <= 40) {
                            const updatedDevice = {
                                ...device,
                                targetTemperature: newTemperature
                            };
                            
                            fetch('/api/devices', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(updatedDevice)
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    loadDevices();
                                }
                            })
                            .catch(error => console.error('Ошибка обновления температуры:', error));
                        }
                    }
                })
                .catch(error => console.error('Ошибка получения устройства:', error));
        }
        
        // Включение/выключение устройства
        function toggleDevice(macAddress, enabled) {
            fetch('/api/devices')
                .then(response => response.json())
                .then(data => {
                    const device = data.devices.find(d => d.macAddress === macAddress);
                    if (device) {
                        const updatedDevice = {
                            ...device,
                            enabled: enabled
                        };
                        
                        fetch('/api/devices', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(updatedDevice)
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                loadDevices();
                            }
                        })
                        .catch(error => console.error('Ошибка обновления устройства:', error));
                    }
                })
                .catch(error => console.error('Ошибка получения устройства:', error));
        }
        
        // Получение класса для индикатора батареи
        function getBatteryClass(battery) {
            if (battery < 20) return 'battery-low';
            if (battery < 50) return 'battery-medium';
            return '';
        }
        
        // Форматирование времени работы
        function formatTime(seconds) {
            if (!seconds) return '0 мин';
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (hours > 0) {
                return `${hours} ч ${minutes} мин`;
            } else {
                return `${minutes} мин`;
            }
        }
    </script>
</body>
</html>
