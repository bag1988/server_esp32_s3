<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление устройствами Xiaomi</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow-x: auto;
        }

        h1,
        h2 {
            color: #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f2f2f2;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }

        button:hover {
            background-color: #45a049;
        }

        button.scan {
            background-color: #2196F3;
        }

        button.scan:hover {
            background-color: #0b7dda;
        }

        button.save {
            background-color: #ff9800;
        }

        button.save:hover {
            background-color: #e68a00;
        }

        input,
        select {
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .gpio-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .gpio-item {
            display: flex;
            align-items: center;
        }

        .status {
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
        }

        .success {
            background-color: #dff0d8;
            color: #3c763d;
        }

        .error {
            background-color: #f2dede;
            color: #a94442;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Управление устройствами Xiaomi</h1>
        <div>
            <a href="/stats">Статистика обогрева</a>
            <!-- <a href="/mihome">Настройка Mi Home</a> -->
            <a href="/index2">Сканирование</a>
        </div>
        <br />
        <div>
            <button class="scan" onclick="startScan()">Запустить BLE сканирование</button>
            <button onclick="loadClients()">Обновить список устройств</button>
        </div>
        <div id="scanStatus"></div>
    </div>

    <div class="container">
        <h2>Список устройств</h2>
        <table id="clientsTable">
            <thead>
                <tr>
                    <th>Имя</th>
                    <th>MAC-адрес</th>
                    <th>Температура</th>
                    <th>Целевая температура</th>
                    <th>Влажность</th>
                    <th>Заряд батареи</th>
                    <th>Активно</th>
                    <th>GPIO пины</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody id="clientsTableBody">
                <!-- Данные будут загружены через JavaScript -->
            </tbody>
        </table>
    </div>

    <div class="container">
        <h2>Доступные GPIO пины</h2>
        <div id="gpioContainer" class="gpio-container">
            <!-- GPIO пины будут загружены через JavaScript -->
        </div>
        <button class="save" onclick="saveGpioPins()">Сохранить GPIO пины</button>
        <div id="gpioStatus"></div>
    </div>
    <div class="container">
        <h2>Информация о сервере</h2>
        <div id="serverInfoContainer">
            <!-- Отображение информации о сервере -->
        </div>
    </div>

    <script>
        // Загрузка списка клиентов
        function loadClients() {
            fetch('/clients')
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('clientsTableBody');
                    tableBody.innerHTML = '';

                    data.forEach(client => {
                        const row = document.createElement('tr');

                        // Имя
                        const nameCell = document.createElement('td');
                        const nameInput = document.createElement('input');
                        nameInput.type = 'text';
                        nameInput.value = client.name || '';
                        nameInput.dataset.address = client.macAddress;
                        nameInput.dataset.field = 'name';
                        nameCell.appendChild(nameInput);

                        // MAC-адрес
                        const macCell = document.createElement('td');
                        macCell.textContent = client.macAddress;

                        // Температура
                        const tempCell = document.createElement('td');
                        tempCell.textContent = client.temperature ? client.temperature.toFixed(1) + '°C' : 'Н/Д';

                        // Целевая температура
                        const targetTempCell = document.createElement('td');
                        const targetTempInput = document.createElement('input');
                        targetTempInput.type = 'number';
                        targetTempInput.step = '0.1';
                        targetTempInput.value = client.targetTemperature || '';
                        targetTempInput.dataset.address = client.macAddress;
                        targetTempInput.dataset.field = 'targetTemperature';
                        targetTempCell.appendChild(targetTempInput);

                        // Влажность
                        const humidityCell = document.createElement('td');
                        humidityCell.textContent = client.humidity ? client.humidity.toFixed(1) + '%' : 'Н/Д';

                        // Заряд батареи
                        const batteryCell = document.createElement('td');
                        batteryCell.textContent = client.battery ? client.battery + '%' : 'Н/Д';

                        // Активно
                        const enabledCell = document.createElement('td');
                        const enabledCheckbox = document.createElement('input');
                        enabledCheckbox.type = 'checkbox';
                        enabledCheckbox.checked = client.enabled;
                        enabledCheckbox.dataset.address = client.macAddress;
                        enabledCheckbox.dataset.field = 'enabled';
                        enabledCell.appendChild(enabledCheckbox);

                        // GPIO пины
                        const gpioCell = document.createElement('td');
                        const gpioSelect = document.createElement('select');
                        gpioSelect.multiple = true;
                        gpioSelect.size = 3;
                        gpioSelect.dataset.address = client.macAddress;
                        gpioSelect.dataset.field = 'gpioPins';

                        // Загрузим доступные GPIO пины для выбора
                        fetch('/availablegpio')
                            .then(response => response.json())
                            .then(gpioPins => {
                                gpioPins.forEach(pin => {
                                    const option = document.createElement('option');
                                    option.value = pin;
                                    option.textContent = 'GPIO ' + pin;

                                    // Если пин уже назначен этому устройству, выбираем его
                                    if (client.gpioPins && client.gpioPins.includes(pin)) {
                                        option.selected = true;
                                    }

                                    gpioSelect.appendChild(option);
                                });
                            });

                        gpioCell.appendChild(gpioSelect);

                        // Кнопка сохранения
                        const actionCell = document.createElement('td');
                        const saveButton = document.createElement('button');
                        saveButton.textContent = 'Сохранить';
                        saveButton.onclick = () => saveClient(client.macAddress);
                        actionCell.appendChild(saveButton);

                        // Добавляем ячейки в строку
                        row.appendChild(nameCell);
                        row.appendChild(macCell);
                        row.appendChild(tempCell);
                        row.appendChild(targetTempCell);
                        row.appendChild(humidityCell);
                        row.appendChild(batteryCell);
                        row.appendChild(enabledCell);
                        row.appendChild(gpioCell);
                        row.appendChild(actionCell);

                        // Добавляем строку в таблицу
                        tableBody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Ошибка при загрузке клиентов:', error);
                });
        }

        // Сохранение информации о клиенте
        function saveClient(address) {
            const nameInput = document.querySelector(`input[data-address="${address}"][data-field="name"]`);
            const targetTempInput = document.querySelector(`input[data-address="${address}"][data-field="targetTemperature"]`);
            const enabledCheckbox = document.querySelector(`input[data-address="${address}"][data-field="enabled"]`);
            const gpioSelect = document.querySelector(`select[data-address="${address}"][data-field="gpioPins"]`);

            const formData = new FormData();
            formData.append('address', address);

            if (nameInput) {
                formData.append('name', nameInput.value);
            }

            if (targetTempInput) {
                formData.append('targetTemperature', targetTempInput.value);
            }

            if (enabledCheckbox) {
                formData.append('enabled', enabledCheckbox.checked ? 'true' : 'false');
            }

            if (gpioSelect) {
                const selectedPins = Array.from(gpioSelect.selectedOptions).map(option => option.value);
                formData.append('gpioPins', JSON.stringify(selectedPins));
            }

            fetch('/client', {
                method: 'POST',
                body: formData
            })
                .then(response => response.text())
                .then(data => {
                    alert('Устройство обновлено: ' + data);
                    loadClients(); // Перезагрузка списка клиентов
                })
                .catch(error => {
                    console.error('Ошибка при сохранении клиента:', error);
                    alert('Ошибка при сохранении клиента');
                });
        }

        // Загрузка доступных GPIO пинов
        function loadGpioPins() {
            fetch('/availablegpio')
                .then(response => response.json())
                .then(data => {
                    const gpioContainer = document.getElementById('gpioContainer');
                    gpioContainer.innerHTML = '';

                    data.forEach(gpioItem => {
                        const gpioDiv = document.createElement('div');
                        gpioDiv.className = 'gpio-item';

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = 'gpio-' + gpioItem.pin;
                        checkbox.value = gpioItem.pin;
                        checkbox.dataset.name = gpioItem.name;

                        const label = document.createElement('label');
                        label.htmlFor = 'gpio-' + gpioItem.pin;
                        label.textContent = `GPIO ${gpioItem.pin} (${gpioItem.name})`;

                        const nameInput = document.createElement('input');
                        nameInput.type = 'text';
                        nameInput.value = gpioItem.name;
                        nameInput.dataset.pin = gpioItem.pin;
                        nameInput.placeholder = 'Название';

                        gpioDiv.appendChild(checkbox);
                        gpioDiv.appendChild(label);
                        gpioDiv.appendChild(nameInput);
                        gpioContainer.appendChild(gpioDiv);
                    });
                })
                .catch(error => {
                    console.error('Ошибка при загрузке GPIO пинов:', error);
                });
        }

        // Сохранение доступных GPIO пинов
        function saveGpioPins() {
            const checkboxes = document.querySelectorAll('#gpioContainer input[type="checkbox"]');
            const gpioItems = Array.from(checkboxes).map(cb => {
                const nameInput = document.querySelector(`input[data-pin="${cb.value}"]`);
                return {
                    pin: parseInt(cb.value),
                    name: nameInput ? nameInput.value : `GPIO ${cb.value}`
                };
            });

            const formData = new FormData();
            formData.append('availablegpio', JSON.stringify(gpioItems));

            fetch('/availablegpio', {
                method: 'POST',
                body: formData
            })
                .then(response => response.text())
                .then(data => {
                    const statusDiv = document.getElementById('gpioStatus');
                    statusDiv.textContent = 'GPIO пины успешно обновлены';
                    statusDiv.className = 'status success';
                    setTimeout(() => {
                        statusDiv.textContent = '';
                        statusDiv.className = '';
                    }, 3000);
                })
                .catch(error => {
                    console.error('Ошибка при сохранении GPIO пинов:', error);
                    const statusDiv = document.getElementById('gpioStatus');
                    statusDiv.textContent = 'Ошибка при сохранении GPIO пинов';
                    statusDiv.className = 'status error';
                });
        }

        // Запуск BLE сканирования
        function startScan() {
            const statusDiv = document.getElementById('scanStatus');
            statusDiv.textContent = 'Сканирование запущено...';
            statusDiv.className = 'status';

            fetch('/scan')
                .then(response => response.text())
                .then(data => {
                    statusDiv.textContent = data;
                    statusDiv.className = 'status success';

                    // Через 10 секунд обновляем список клиентов
                    setTimeout(() => {
                        loadClients();
                        statusDiv.textContent = 'Сканирование завершено, список устройств обновлен';
                    }, 10000);
                })
                .catch(error => {
                    console.error('Ошибка при запуске сканирования:', error);
                    statusDiv.textContent = 'Ошибка при запуске сканирования';
                    statusDiv.className = 'status error';
                });
        }

        function loadServerInfo() {
            fetch('/serverinfo')
                .then(response => response.json())
                .then(data => {
                    const serverContainer = document.getElementById('serverInfoContainer');
                    serverContainer.innerHTML = '';

                    const temperature = document.createElement("div");
                    temperature.innerHTML = `Температура: ${data.board_temperature} C`;
                    serverContainer.appendChild(temperature);
                   
                    const workTime = document.createElement("div");
                    workTime.innerHTML = `Время работы: ${data.millis}`;
                    serverContainer.appendChild(workTime);

                    const cpu_frequency_mhz = document.createElement("div");
                    cpu_frequency_mhz.innerHTML = `Частота CPU: ${data.cpu_frequency_mhz}`;
                    serverContainer.appendChild(cpu_frequency_mhz);
                    const sram_size_bytes = document.createElement("div");
                    sram_size_bytes.innerHTML = `Размер SRAM: ${data.sram_size_bytes}`;
                    serverContainer.appendChild(sram_size_bytes);
                    const free_sram_bytes = document.createElement("div");
                    free_sram_bytes.innerHTML = `Свободная SRAM: ${data.free_sram_bytes}`;
                    serverContainer.appendChild(free_sram_bytes);

                    const flash_size_bytes = document.createElement("div");
                    flash_size_bytes.innerHTML = `Размер Flash: ${data.flash_size_bytes}`;
                    serverContainer.appendChild(flash_size_bytes);

                    const psram_size_bytes = document.createElement("div");
                    psram_size_bytes.innerHTML = `Размер PSRAM: ${data.psram_size_bytes}`;
                    serverContainer.appendChild(psram_size_bytes);
                    const free_psram_bytes = document.createElement("div");
                    free_psram_bytes.innerHTML = `Свободная PSRAM: ${data.free_psram_bytes}`;
                    serverContainer.appendChild(free_psram_bytes);
                })
                .catch(error => {
                    console.error('Ошибка при загрузке информации о сервере:', error);
                });
        }

        // Инициализация страницы
        window.onload = function () {
            loadClients();
            loadGpioPins();

            loadServerInfo();
        };
    </script>
</body>

</html>