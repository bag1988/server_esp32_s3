<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление устройствами Xiaomi</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .device {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .device-name {
            font-size: 18px;
            font-weight: bold;
        }
        .device-info {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .device-info div {
            background-color: #f0f0f0;
            padding: 5px 10px;
            border-radius: 3px;
        }
        .device-controls {
            margin-top: 15px;
        }
        .device-controls label {
            display: block;
            margin-bottom: 5px;
        }
        .device-controls input, .device-controls select {
            margin-bottom: 10px;
            padding: 5px;
            width: 100%;
        }
        .device-controls button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 3px;
            cursor: pointer;
        }
        .device-controls button:hover {
            background-color: #45a049;
        }
        .scan-button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 3px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .scan-button:hover {
            background-color: #0b7dda;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2196F3;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .gpio-select {
            margin-top: 10px;
        }
        .gpio-select select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
        }
        .gpio-select button {
            background-color: #ff9800;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 5px;
        }
        .gpio-select button:hover {
            background-color: #e68a00;
        }
        .selected-gpio {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        .selected-gpio span {
            background-color: #e0e0e0;
            padding: 5px 10px;
            border-radius: 3px;
            display: flex;
            align-items: center;
        }
        .selected-gpio span button {
            background: none;
            border: none;
            color: red;
            cursor: pointer;
            margin-left: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Управление устройствами Xiaomi</h1>
        <div>
            <a href="/stats">Статистика обогрева</a>
            <a href="/mihome_status">Настройка Mi Home</a>
            <a href="/index">На главную</a>
        </div>
        <br/>
        <button id="scanButton" class="scan-button">Сканировать устройства</button>
        <div id="devicesList"></div>
    </div>

    <script>
        // Загрузка списка устройств
        async function loadDevices() {
            try {
                const response = await fetch('/clients');
                const devices = await response.json();
                displayDevices(devices);
            } catch (error) {
                console.error('Ошибка при загрузке устройств:', error);
            }
        }

        // Загрузка доступных GPIO пинов
        async function loadAvailableGpio() {
            try {
                const response = await fetch('/availablegpio');
                return await response.json();
            } catch (error) {
                console.error('Ошибка при загрузке GPIO пинов:', error);
                return [];
            }
        }

        // Отображение устройств на странице
        async function displayDevices(devices) {
            const devicesList = document.getElementById('devicesList');
            devicesList.innerHTML = '';
            
            const availableGpio = await loadAvailableGpio();
            
            devices.forEach(device => {
                const deviceElement = document.createElement('div');
                deviceElement.className = 'device';
                
                // Заголовок устройства
                const header = document.createElement('div');
                header.className = 'device-header';
                
                const nameElement = document.createElement('div');
                nameElement.className = 'device-name';
                nameElement.textContent = device.name || `Устройство ${device.macAddress}`;
                
                const enabledToggle = document.createElement('label');
                enabledToggle.className = 'toggle-switch';
                enabledToggle.innerHTML = `
                    <input type="checkbox" ${device.enabled ? 'checked' : ''} id="enabled-${device.macAddress}">
                    <span class="slider"></span>
                `;
                
                header.appendChild(nameElement);
                header.appendChild(enabledToggle);
                deviceElement.appendChild(header);
                
                // Информация об устройстве
                const info = document.createElement('div');
                info.className = 'device-info';
                
                const macAddress = document.createElement('div');
                macAddress.textContent = `MAC: ${device.macAddress}`;
                
                const temperature = document.createElement('div');
                temperature.textContent = `Температура: ${device.temperature}°C`;
                
                const battery = document.createElement('div');
                battery.textContent = `Батарея: ${device.battery}%`;
                
                info.appendChild(macAddress);
                info.appendChild(temperature);
                info.appendChild(battery);
                deviceElement.appendChild(info);
                
                // Элементы управления
                const controls = document.createElement('div');
                controls.className = 'device-controls';
                
                // Имя устройства
                const nameLabel = document.createElement('label');
                nameLabel.textContent = 'Имя устройства:';
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.value = device.name || '';
                nameInput.id = `name-${device.macAddress}`;
                
                // Целевая температура
                const tempLabel = document.createElement('label');
                tempLabel.textContent = 'Целевая температура (°C):';
                const tempInput = document.createElement('input');
                tempInput.type = 'number';
                tempInput.step = '0.5';
                tempInput.value = device.targetTemperature || 20;
                tempInput.id = `temp-${device.macAddress}`;
                
                // Выбор GPIO пинов
                const gpioLabel = document.createElement('label');
                gpioLabel.textContent = 'GPIO пины:';
                
                const gpioSelect = document.createElement('div');
                gpioSelect.className = 'gpio-select';
                
                const select = document.createElement('select');
                select.id = `gpio-select-${device.macAddress}`;
                
                availableGpio.forEach(gpio => {
                    const option = document.createElement('option');
                    option.value = gpio.pin;
                    option.textContent = `${gpio.name} (GPIO ${gpio.pin})`;
                    select.appendChild(option);
                });
                
                const addButton = document.createElement('button');
                addButton.textContent = 'Добавить';
                addButton.onclick = () => addGpioPin(device.macAddress);
                
                gpioSelect.appendChild(select);
                gpioSelect.appendChild(addButton);
                
                // Отображение выбранных GPIO пинов
                const selectedGpio = document.createElement('div');
                selectedGpio.className = 'selected-gpio';
                selectedGpio.id = `selected-gpio-${device.macAddress}`;
                
                if (device.gpioPins && device.gpioPins.length > 0) {
                    device.gpioPins.forEach(pin => {
                        const pinElement = document.createElement('span');
                        const gpioInfo = availableGpio.find(g => g.pin === pin) || { name: `GPIO ${pin}` };
                        pinElement.textContent = gpioInfo.name;
                        
                        const removeButton = document.createElement('button');
                        removeButton.textContent = '×';
                        removeButton.onclick = () => removeGpioPin(device.macAddress, pin);
                        
                        pinElement.appendChild(removeButton);
                        selectedGpio.appendChild(pinElement);
                    });
                }
                
                // Кнопка сохранения
                const saveButton = document.createElement('button');
                saveButton.textContent = 'Сохранить';
                saveButton.onclick = () => saveDevice(device.macAddress);
                
                controls.appendChild(nameLabel);
                controls.appendChild(nameInput);
                controls.appendChild(tempLabel);
                controls.appendChild(tempInput);
                controls.appendChild(gpioLabel);
                controls.appendChild(gpioSelect);
                controls.appendChild(selectedGpio);
                controls.appendChild(saveButton);
                
                deviceElement.appendChild(controls);
                devicesList.appendChild(deviceElement);
                
                // Обработчик переключателя
                document.getElementById(`enabled-${device.macAddress}`).addEventListener('change', function() {
                    saveDeviceEnabled(device.macAddress, this.checked);
                });
            });
        }

        // Добавление GPIO пина
        function addGpioPin(macAddress) {
            const select = document.getElementById(`gpio-select-${macAddress}`);
            const selectedPin = parseInt(select.value);
            const selectedText = select.options[select.selectedIndex].text;
            
            const selectedGpio = document.getElementById(`selected-gpio-${macAddress}`);
            
            // Проверяем, не добавлен ли уже этот пин
            const existingPins = Array.from(selectedGpio.children).map(span => 
                parseInt(span.getAttribute('data-pin'))
            );
            
            if (!existingPins.includes(selectedPin)) {
                const pinElement = document.createElement('span');
                pinElement.textContent = selectedText;
                pinElement.setAttribute('data-pin', selectedPin);
                
                const removeButton = document.createElement('button');
                removeButton.textContent = '×';
                removeButton.onclick = () => removeGpioPin(macAddress, selectedPin);
                
                pinElement.appendChild(removeButton);
                selectedGpio.appendChild(pinElement);
            }
        }

        // Удаление GPIO пина
        function removeGpioPin(macAddress, pin) {
            const selectedGpio = document.getElementById(`selected-gpio-${macAddress}`);
            const pinElements = selectedGpio.querySelectorAll('span');
            
            pinElements.forEach(element => {
                if (parseInt(element.getAttribute('data-pin')) === pin) {
                    element.remove();
                }
            });
        }

        // Сохранение устройства
        async function saveDevice(macAddress) {
            const name = document.getElementById(`name-${macAddress}`).value;
            const targetTemperature = document.getElementById(`temp-${macAddress}`).value;
            const enabled = document.getElementById(`enabled-${macAddress}`).checked;
            
            // Собираем выбранные GPIO пины
            const selectedGpio = document.getElementById(`selected-gpio-${macAddress}`);
            const gpioPins = Array.from(selectedGpio.children).map(span => 
                parseInt(span.getAttribute('data-pin'))
            );
            
            const formData = new FormData();
            formData.append('address', macAddress);
            formData.append('name', name);
            formData.append('targetTemperature', targetTemperature);
            formData.append('enabled', enabled);
            formData.append('gpioPins', JSON.stringify(gpioPins));
            
            try {
                const response = await fetch('/client', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    alert('Устройство успешно обновлено');
                    loadDevices();
                } else {
                    alert('Ошибка при обновлении устройства');
                }
            } catch (error) {
                console.error('Ошибка при сохранении устройства:', error);
                alert('Ошибка при сохранении устройства');
            }
        }

        // Сохранение состояния включения устройства
        async function saveDeviceEnabled(macAddress, enabled) {
            const formData = new FormData();
            formData.append('address', macAddress);
            formData.append('enabled', enabled);
            
            try {
                await fetch('/client', {
                    method: 'POST',
                    body: formData
                });
            } catch (error) {
                console.error('Ошибка при обновлении состояния устройства:', error);
            }
        }

        // Запуск сканирования устройств
        async function scanDevices() {
            try {
                await fetch('/scan');
                alert('Сканирование запущено. Обновление списка через 5 секунд...');
                setTimeout(loadDevices, 5000);
            } catch (error) {
                console.error('Ошибка при запуске сканирования:', error);
                alert('Ошибка при запуске сканирования');
            }
        }

        // Обработчик кнопки сканирования
        document.getElementById('scanButton').addEventListener('click', scanDevices);

        // Загрузка устройств при загрузке страницы
        window.addEventListener('load', loadDevices);
    </script>
</body>
</html>