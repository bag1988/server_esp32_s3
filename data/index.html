<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление отоплением</title>
    <link href="app.css" rel="stylesheet" />
</head>

<body>
    <div class="container">
        <h1>Управление отоплением</h1>
        <div class="menu">
            <a href="index.html">Главная</a>
            <a href="heating_stats.html">Статистика обогрева</a>
            <a href="managment_device.html">Управление устройствами</a>
            <a href="gpio_settings.html">Настройки GPIO</a>
        </div>
    </div>

    <div class="container">
        <h2>Список устройств</h2>
        <div id="devicesList" class="device-container"></div>
    </div>

    <div class="container">
        <h2>Информация о сервере</h2>
        <div id="serverInfoContainer">
            <!-- Отображение информации о сервере -->
        </div>
        <button onclick="resetWorkTime()" style="background-color: chocolate;">Сбросить время работы</button>
    </div>

    <div class="container">
        <h2>Гистерезис температуры</h2>
        <div>
            <input type="number" id="hysteresis_temp" name="hysteresis_temp" min="1" max="10" step="0.1"></input>
            <button type="button" onclick="saveHysteresisTemp()">Сохранить</button>
        </div>        
    </div>
    </div>

    <script>
        // Загрузка списка клиентов
        function loadClients() {
            fetch('/clients')
                .then(response => response.json())
                .then(data => {
                    displayDevices(data);
                })
                .catch(error => {
                    console.error('Ошибка при загрузке клиентов:', error);
                });
        }

        async function resetWorkTime() {
            if (!confirm('Вы уверены, что хотите сбросить время работы?')) {
                return;
            }

            try {
                const response = await fetch('/reset_work_time', {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Время работы сброшено');
                } else {
                    alert('Ошибка при сбросе времени работы');
                }
            } catch (error) {
                console.error('Ошибка при сбросе времени работы:', error);
                alert('Ошибка при сбросе времени работы');
            }
        }

        // Отображение устройств на странице
        function displayDevices(devices) {
            const devicesList = document.getElementById('devicesList');
            devicesList.innerHTML = '';

            devices.forEach(device => {
                const deviceElement = document.createElement('div');
                deviceElement.className = 'device';

                // Заголовок устройства
                const header = document.createElement('div');
                header.className = 'device-header';

                const nameElement = document.createElement('div');
                nameElement.className = 'device-name';
                nameElement.textContent = device.name || `Устройство ${device.macAddress}`;
                nameElement.dataset.online = device.isOnline;
                header.appendChild(nameElement);
                deviceElement.appendChild(header);

                // Информация об устройстве
                const info = document.createElement('div');

                const temperature = document.createElement('div');
                temperature.textContent = `Температура: ${device.currentTemperature}°C/${device.targetTemperature}°C`;

                const humidity = document.createElement('div');
                humidity.textContent = `Влажность: ${device.humidity}%`;
                const battery = document.createElement('div');
                battery.textContent = `Батарея: ${device.battery}% (${device.batteryV})`;

                const devEnabled = document.createElement('div');
                devEnabled.textContent = `Статус: ${device.enabled ? 'включен' : 'выключен'}`;

                const heatingActive = document.createElement('div');
                heatingActive.textContent = `Обогрев: ${device.heatingActive ? 'включен' : 'выключен'}`;
                if (device.heatingActive) {
                    heatingActive.style.color = 'orange';
                }
                info.appendChild(temperature);
                info.appendChild(humidity);
                info.appendChild(battery);
                info.appendChild(devEnabled);
                info.appendChild(heatingActive);
                deviceElement.appendChild(info);
                devicesList.appendChild(deviceElement);
            });
        }

        function loadServerInfo() {
            fetch('/serverinfo')
                .then(response => response.json())
                .then(data => {
                    displayServerInfo(data);
                })
                .catch(error => {
                    console.error('Ошибка при загрузке информации о сервере:', error);
                });
        }

        function loadHysteresisTemp() {
            fetch('/get_hysteresis_temp')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('hysteresis_temp').value = data;
                })
                .catch(error => {
                    console.error('Ошибка при загрузке информации о гистерезисе температуры:', error);
                });
        }

        async function saveHysteresisTemp() {
            try {
                const hysteresisTemp = document.getElementById('hysteresis_temp').value;
                if (hysteresisTemp < 1 || hysteresisTemp > 10) {
                    alert("Значение гистерезиса температуры должно быть в диапазоне от 1 до 10");
                    return;
                }

                if (!confirm('Вы уверены, что хотите сохранить новое значение гистерезиса температуры?')) {
                    return;
                }

                const formData = new FormData();
                formData.append('hysteresis_temp', hysteresisTemp);

                const response = await fetch('/save_hysteresis_temp', {
                    method: 'post',
                    body: formData
                });

                if (response.ok) {
                    alert('Гистерезис температуры успешно сохранен');
                } else {
                    alert('Ошибка при сохранении гистерезиса температуры');
                }
            } catch (error) {
                console.error('Ошибка при сохранении гистерезиса температуры:', error);
                alert('Ошибка при сохранении гистерезиса температуры');
            }
        }

        function displayServerInfo(data) {
            const serverContainer = document.getElementById('serverInfoContainer');
            serverContainer.innerHTML = '';

            const temperature = document.createElement("div");
            temperature.innerHTML = `Температура: ${data.board_temperature} C`;
            serverContainer.appendChild(temperature);

            const workTime = document.createElement("div");
            workTime.innerHTML = `Время работы: ${data.millis}`;
            serverContainer.appendChild(workTime);

            const cpu_frequency_mhz = document.createElement("div");
            cpu_frequency_mhz.innerHTML = `Частота CPU: ${data.cpu_frequency_mhz}`;
            serverContainer.appendChild(cpu_frequency_mhz);
            const sram_size_bytes = document.createElement("div");
            sram_size_bytes.innerHTML = `Размер SRAM: ${(data.sram_size_bytes / 1024).toFixed(3)} кб`;
            serverContainer.appendChild(sram_size_bytes);
            const free_sram_bytes = document.createElement("div");
            free_sram_bytes.innerHTML = `Свободная SRAM: ${(data.free_sram_bytes / 1024).toFixed(3)} кб`;
            serverContainer.appendChild(free_sram_bytes);

            const flash_size_bytes = document.createElement("div");
            flash_size_bytes.innerHTML = `Размер Flash: ${(data.flash_size_bytes / 1024 / 1024).toFixed(3)} мб`;
            serverContainer.appendChild(flash_size_bytes);

            const psram_size_bytes = document.createElement("div");
            psram_size_bytes.innerHTML = `Размер PSRAM: ${(data.psram_size_bytes / 1024 / 1024).toFixed(3)} мб`;
            serverContainer.appendChild(psram_size_bytes);
            const free_psram_bytes = document.createElement("div");
            free_psram_bytes.innerHTML = `Свободная PSRAM: ${(data.free_psram_bytes / 1024 / 1024).toFixed(3)} мб`;
            serverContainer.appendChild(free_psram_bytes);
        }

        // Инициализация страницы
        window.onload = function () {
            loadClients();
            loadServerInfo();
            loadHysteresisTemp();
        };
    </script>
</body>

</html>